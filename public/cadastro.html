<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sonora | Cadastro</title>
  <link rel="stylesheet" href="./css/login.css">
  <link rel="shortcut icon" href="./assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/login.css">
</head>

<body>
  <div id="loading"></div>

  <a id="logo" href="index.html">
    <img src="assets/Logo finalizada.svg" alt="Sonora Logo">
    <p>SONORA</p>
  </a>

  <main>
    <h2>CADASTRO</h2>

    <form>
      <div>
        <input type="text" id="empresa" placeholder="Empresa">
        <input type="text" id="cnpj" placeholder="CNPJ" maxlength="18">
      </div>

      <div>
        <input type="text" id="nome" placeholder="Nome">
        <input type="text" id="celular" placeholder="Celular" maxlength="15">
      </div>

      <div>
        <input type="text" id="usuario" placeholder="Usuário">
        <input type="text" id="email" placeholder="E-mail">
      </div>

      <div>
        <input type="password" id="senha" placeholder="Senha" minlength="8">
        <input type="password" id="confirmarSenha" placeholder="Confirmar senha" minlength="8">
      </div>

      <button type="submit">CADASTRAR</button>
    </form>

    <a href="login.html">Já tem conta? Faça o seu login</a>
  </main>

  <script src="js/sessao.js"></script>

  <script>
    function formatCNPJ(value) {
      value = value.replace(/\D/g, "")
      value = value.replace(/(\d{2})(\d)/, "$1.$2")
      value = value.replace(/(\d{3})(\d)/, "$1.$2")
      value = value.replace(/(\d{3})(\d)/, "$1/$2")
      value = value.replace(/(\d{4})(\d)/, "$1-$2")
      return value
    }

    function formatCelular(value) {
      value = value.replace(/\D/g, "")
      value = value.replace(/^(\d{2})(\d)/, "($1) $2")
      value = value.replace(/(\d{5})(\d)/, "$1-$2")
      return value
    }

    document.getElementById("cnpj").addEventListener("input", function (e) {
      e.target.value = formatCNPJ(e.target.value)
    })

    document.getElementById("celular").addEventListener("input", function (e) {
      e.target.value = formatCelular(e.target.value)
    })

    function validarCamposVazios(campos) {
      for (let campo in campos) {
        if (!campos[campo]) {
          alert("Preencha todos os campos.")
          return false
        }
      }
      return true
    }

    function validarSenha(senha, confirmarSenha) {
      if (senha.length < 8) {
        alert("A senha precisa ter pelo menos 8 caracteres.")
        return false
      }

      if (senha !== confirmarSenha) {
        alert("As senhas não coincidem.")
        return false
      }

      const caracteresEspeciais = `!@#$%¨&*()_-=+*/[]{}|\\;:.,`
      let temNumero = false
      let temEspecial = false

      for (let char of senha) {
        if (!isNaN(char)) temNumero = true
        if (caracteresEspeciais.includes(char)) temEspecial = true

        if (temNumero && temEspecial) break
      }

      if (!temNumero || !temEspecial) {
        alert("A senha precisa conter pelo menos 1 número e 1 caractere especial (!@#$%...).")
        return false
      }

      return true
    }

    function validarEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!regex.test(email)) {
        alert("E-mail inválido.")
        return false
      }
      return true
    }

    function cadastrar() {
      const campos = {
        empresa: document.getElementById("empresa").value,
        cnpj: document.getElementById("cnpj").value,
        nome: document.getElementById("nome").value,
        celular: document.getElementById("celular").value,
        usuario: document.getElementById("usuario").value,
        email: document.getElementById("email").value,
        senha: document.getElementById("senha").value,
        confirmarSenha: document.getElementById("confirmarSenha").value
      }

      if (
        !validarCamposVazios(campos) ||
        !validarSenha(campos.senha, campos.confirmarSenha) ||
        !validarEmail(campos.email)
      ) {
        return false
      }

      fetch("/usuarios/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          empresaServer: campos.empresa,
          cnpjServer: campos.cnpj,
          nomeServer: campos.nome,
          celularServer: campos.celular,
          usuarioServer: campos.usuario,
          emailServer: campos.email,
          senhaServer: campos.senha
        }),
      })
        .then(function (resposta) {
          console.log("resposta: ", resposta)

          if (resposta.ok) {
            alert("Cadastro realizado com sucesso! Redirecionando para tela de Login...")
            setTimeout(() => {

              aguardar();
              window.location = "login.html"
            }, 2000)
          } else {
            throw "Houve um erro ao tentar realizar o cadastro!"
          }
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`)
        })
    }

    document.querySelector("form").addEventListener("submit", function (e) {
      e.preventDefault()
      cadastrar()
    })
  </script>

</body>

</html>