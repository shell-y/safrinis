<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>

<body>
    <header>
        <a href="#"><img src="../assets/logo_sonora.svg" class="logo"></a>

        <nav>
            <ul>
                <li class="link-nav sec-atual"><a onclick="limparLineup()" href="cards.html">Home</a>
                <li><a class="link-nav" href="lineup.html">Line-up</a>
                <li>
                    <a href="../index.html">
                        <button onclick="limparSessao()">Sair</button>
                    </a>
            </ul>
        </nav>
    </header>

    <main>
        <h1 id="nome">Dashboard/<span id="nome-lineup"></span></h1>
        <section class="section-kpi">
            <div id="kpi">Índice de Aprovação Potencial<br><span id="iap-value">0%</span></div>
            <div id="kpi">Risco de Engajamento<br><span id="risco-value">0%</span></div>
        </section>
        <section class="grafico-e-tabela">
            <div class="grafico-container">
                <canvas id="graficoIAPxRisco"></canvas>
            </div>
            <div class="tabela-container">
                <table id="tabela-artistas">
                    <thead>
                        <tr>
                            <th>Artista</th>
                            <th>Popularidade</th>
                            <th>IAP</th>
                            <th>Risco</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>
        <section>
            <img src="../assets/logo_sonora.svg" class="logo">

            <address>
                <strong>Sonora</strong><br>
                Haddock Lobo, 595 - Cerqueira César<br>
                São Paulo, SP - Brasil
            </address>

            <div>
                <img src="../assets/icon/redes/instagram.svg" class="icone-rede">
                <img src="../assets/icon/redes/facebook.svg" class="icone-rede">
                <img src="../assets/icon/redes/whatsapp.svg" class="icone-rede">
            </div>

            <small>© 2025 Sonora. Todos o direitos reservados.</small>
        </section>

        <aside>
            <h4>Newsletters</h4>
            <p>Fique por dentro das últimas novidades da música</p>

            <div>
                <input placeholder="seu@email.com">

                <button>
                    Inscreva-se
                </button>
            </div>

            <small>Ao se inscrever, você concorda em receber nossos e-mails e está de acordo com os nossos Termos e
                Condições.</small>
        </aside>
    </footer>
    <script src="../js/sessao.js"></script>
    <script>
        function identificadorDash() {
            let elementoNome = document.getElementById('nome');
            if (elementoNome && sessionStorage.NOME_USUARIO) {
                elementoNome.innerText += `${sessionStorage.LINEUPSELECIONADA}`;
            }
        }
        validarSessao();
        identificadorDash()
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dados brutos da lineup "The Town"
        const artistas = [
            { nome: "Green Day", popularidade: 82, seguidores: 16398514 },
            { nome: "Capital Inicial", popularidade: 64, seguidores: 2941870 },
            { nome: "Pitty", popularidade: 65, seguidores: 2417709 },
            { nome: "Kamasi Washington", popularidade: 55, seguidores: 502714 },
            { nome: "Snarky Puppy", popularidade: 48, seguidores: 736924 },
            { nome: "Ivete Sangalo", popularidade: 69, seguidores: 2175646 },
            { nome: "Katy Perry", popularidade: 86, seguidores: 36582482 },
            { nome: "Camila Cabello", popularidade: 81, seguidores: 34774468 },
            { nome: "João Bosco", popularidade: 49, seguidores: 381059 },
            { nome: "Gaby Amarantos", popularidade: 41, seguidores: 58368 }
        ];

        // Funções para cálculo de IAP e Risco
        function calcularIAP(popularidade, seguidores) {
            const crescimento = Math.random() * 50;
            const normPop = popularidade / 100;
            const normFollowers = Math.log10(seguidores + 1) / 6;
            const normCrescimento = Math.min(crescimento / 100, 1);
            return ((normPop * 0.4 + normFollowers * 0.3 + normCrescimento * 0.3) * 100).toFixed(1);
        }

        function calcularRisco(popularidade, seguidores) {
            const baseAntiga = seguidores * (0.5 + Math.random() * 0.3);
            const normPopHist = 1 - (popularidade / 100);
            const normFollowersHist = 1 - (Math.log10(baseAntiga + 1) / 6);
            const inatividade = Math.random() > 0.7 ? 1 : 0;
            const risco = ((normPopHist * 0.4 + normFollowersHist * 0.4 + inatividade * 0.2) * 100).toFixed(1);
            return risco < 0 ? 0 : risco;
        }

        // Calcular métricas para todos os artistas
        const artistasComMetricas = artistas.map(artista => {
            return {
                ...artista,
                iap: parseFloat(calcularIAP(artista.popularidade, artista.seguidores)),
                risco: parseFloat(calcularRisco(artista.popularidade, artista.seguidores))
            };
        });

        // Preparar dados para o gráfico
        const data = {
            datasets: [{
                label: 'Artistas na lineup The Town',
                data: artistasComMetricas.map(a => ({
                    x: a.iap,
                    y: a.risco,
                    label: a.nome
                })),
                backgroundColor: 'rgba(87, 168, 222, 0.8)',
                borderColor: 'rgba(255, 255, 255, 0.8)',
                borderWidth: 1,
                pointRadius: 6,
                pointHoverRadius: 10
            }]
        };

        // Configuração do gráfico
        const config = {
            type: 'scatter',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 16, weight: 'bold' },
                        bodyFont: { size: 14 },
                        callbacks: {
                            label: function (ctx) {
                                const artista = ctx.raw;
                                return [
                                    artista.label,
                                    `IAP: ${artista.x}%`,
                                    `Risco: ${artista.y}%`
                                ];
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Matriz IAP x Risco - Line-up ' + sessionStorage.LINEUPSELECIONADA,
                        font: { size: 20, weight: 'bold' },
                        color: '#fff',
                        padding: { top: 20, bottom: 20 }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'IAP (%)',
                            color: '#fff',
                            font: { size: 14, weight: 'bold' }
                        },
                        min: 0,
                        max: 100,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#fff' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Risco de Engajamento (%)',
                            color: '#fff',
                            font: { size: 14, weight: 'bold' }
                        },
                        min: 0,
                        max: 50,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#fff' }
                    }
                }
            }
        };

        function preencherTabela(artistas) {
            const tbody = document.querySelector('#tabela-artistas tbody');
            tbody.innerHTML = '';

            // Ordenar artistas por IAP (do maior para o menor)
            artistas.sort((a, b) => b.iap - a.iap);

            artistas.forEach((artista, index) => {
                const row = document.createElement('tr');

                // Adicionar classe para linhas pares/ímpares
                row.className = index % 2 === 0 ? 'even' : 'odd';

                row.innerHTML = `
                    <td>
                        <div class="artista-info">
                            <span class="artista-pos">${index + 1}</span>
                            <span class="artista-nome">${artista.nome}</span>
                        </div>
                    </td>
                    <td>${artista.popularidade}%</td>
                    <td>${artista.iap}%</td>
                    <td>${artista.risco}%</td>
                `;

                // Adicionar evento de clique para destacar no gráfico
                row.addEventListener('click', () => {
                    destacarArtistaNoGrafico(artista.nome);
                });

                tbody.appendChild(row);
            });
        }

        function destacarArtistaNoGrafico(nomeArtista) {
            // Implementação para destacar o ponto correspondente no gráfico
            console.log(`Artista selecionado: ${nomeArtista}`);
            // Você pode implementar a lógica para destacar o ponto no gráfico Chart.js aqui
        }

        // Chamar a função após criar artistasComMetricas
        preencherTabela(artistasComMetricas);


        // Atualizar KPIs
        function calcularMedia(lista, chave) {
            const soma = lista.reduce((acc, item) => acc + item[chave], 0);
            return (soma / lista.length).toFixed(1);
        }

        function updateKPIs() {
            const mediaIAP = calcularMedia(artistasComMetricas, 'iap');
            const mediaRisco = calcularMedia(artistasComMetricas, 'risco');

            document.getElementById('iap-value').textContent = `${mediaIAP}%`;
            document.getElementById('risco-value').textContent = `${mediaRisco}%`;
            const nomeLineupSpan = document.getElementById('nome-lineup');
            if (nomeLineupSpan && sessionStorage.LINEUPSELECIONADA) {
                nomeLineupSpan.textContent = sessionStorage.LINEUPSELECIONADA;
            }


            // Animar os KPIs
            const kpis = document.querySelectorAll('#kpi');
            kpis.forEach((kpi, index) => {
                kpi.style.opacity = 0;
                setTimeout(() => {
                    kpi.style.transition = 'opacity 0.6s ease-out';
                    kpi.style.opacity = 1;
                }, index * 200);
            });
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            validarSessao();
            updateKPIs();

            const canvas = document.getElementById('graficoIAPxRisco');
            console.log("Canvas encontrado?", !!canvas); // Deve imprimir true
            new Chart(canvas, config);
        });

    </script>

</body>

</html>