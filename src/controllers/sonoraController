const artistaModel = require("../models/artistaModel");

function listar(req, res) {
    artistaModel
        .listarQtdDados()
        .then(resultado => {
            if (resultado.length > 0) res.json(resultado);
        })
        .catch(erro => {
            res.status(500).send();
        });
}

function listarPais(req, res) {
    artistaModel
        .listarPais()
        .then(resultado => {
            if (resultado.length > 0) res.json(resultado);
        })
        .catch(err => {
            res.status(500).send();
        });
}

function criar(req, res) {
    const infos = {
        nome: req.nome,
        idRelacionado: req.idRelacionado
    };
    
    artistaModel
        .criar(infos)
        .then(resposta => {
            if (resposta.serverStatus == 2) res.status(200).send();
        })
        .catch(erro => {
            res.status(500).send();
        });
}

function editar(req, res) {
    infos = {
        id: req.id,
        nome: req.nome,
        idRelacionado: req.idRelacionado
    };

    artistaModel
        .editar(infos)
        .then(resposta => {
            if (resposta.serverStatus == 2) res.status(200).send();
        })
        .catch(erro => {
            res.status(500).send();
        });
}

async function deletar(req, res) {
    const idArtista = req.params.idArtista;

    const models = {
        la: require("../models/lineupArtistaModel"),
        ls: require("../models/lastFmModel"),
        s: require("../models/spotifyModel")
    };
    
    try {
        let sucesso = true

        for(const key of Object.keys(models)) {
            const remocao = await models[key].deletarRegistrosArtista(idArtista);
            
            if (remocao.serverStatus !== 2) {
                sucesso = false;
                break
            }
        }

        if (sucesso) {
            const remocao = await artistaModel.deletar(idArtista);
            if (remocao.serverStatus === 2) req.status(200).send();
        } else {
            console.log(remocao)
            req.status(400).send("NÃ£o pode deletar um artista pai!");
        }

    } catch (erro) {
        console.log(erro);
        req.status(500).send();
    }
        
}

module.exports = {
    listar,
    listarPais,
    criar,
    editar,
    deletar
}